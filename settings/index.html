<html>
	<head>
		<!-- Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113319025-1"></script>
		<script>
  			window.dataLayer = window.dataLayer || [];
  			function gtag(){dataLayer.push(arguments);}
  			gtag('js', new Date());
			gtag('config', 'UA-113319025-1');
		</script>
		<!-- End of Google Analytics -->

		<title>Settings | Caterpillars Count!</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Fanwood+Text:400i" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
		<link href="../css/template.css" rel="stylesheet">
		<script src="../js/template.js"></script>
		<style>
			.superUsersOnly{
				display:none;
			}
			
			.setting{
				margin:20px 0px;
				border-radius:4px;
				overflow:hidden;
				border:2px solid #eee;
			}
			
			.settingTitle{
				font-size:20px;
				background:#f7f7f7;
				color:#aaa;
				padding:20px;
				cursor:pointer;
				
			}
			.settingBody{
				font-size:14px;
				background:#f7f7f7;
				max-height:0px;
				overflow:hidden;
				border-right:2px solid #eee;
				border-bottom:2px solid #eee;
			}
			.settingTitle, .settingBody{
				font-family: 'Roboto Slab', serif;
			}
			
			.settingBody>div{
				padding:20px;
			}
			
			main .panel .settingBody button{
				margin:20px auto 5px auto;
			}
			
			#getEmailsLoading{
				text-align:center;
			}
			
			#getEmailsLoading img{
				height:40px;
			}
			
			#emails{
				display:none;
			}
			
			.group{
				margin-top:30px;
			}
			
			.group:first-of-type{
				margin-top:0px;
			}
			
			.inputTitle{
				font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
				color:#666;
				text-transform:uppercase;
				font-size:14px;
			}
			
			textarea{
				width:100%;
				background:#fff;
				border:1px solid #ddd;
				border-bottom:2px solid #ddd;
				font-size:16px;
				padding:16px;
				box-sizing:border-box;
				border-radius:4px;
				margin:5px 0px;
				color:#aaa;
				-webkit-appearance: none;
    				-moz-appearance: none;
    				appearance: none;
				font-family: Arial, sans-serif;
				height:54px;
				overflow:hidden;
				resize: vertical;
				height:54px;
			}
			
			.textareaHolder{
				position:relative;
			}
			
			.textareaOtherLinesCover{
				background:#fff;
				position:absolute;
				bottom:7px;
				left:16px;
				right:16px;
				height:16px;
				pointer-events: none;
			}
		</style>
		<script>
			requireLogIn();
			
			$(document).ready(function(){
				loadBackgroundImage($("#splashImage"), "../images/splash.png");
				
				if(window.localStorage.getItem("email") == ["plocharczykweb", "gmail.com"].join("@") || window.localStorage.getItem("email") == ["hurlbert", "bio.unc.edu"].join("@") || window.localStorage.getItem("email") == ["sarah.yelton", "unc.edu"].join("@") || window.localStorage.getItem("email") == ["ssnell", "live.unc.edu"].join("@") || window.localStorage.getItem("email") == ["gdicecco", "live.unc.edu"].join("@")){
				   	$(".superUsersOnly").stop().fadeIn(0);
					$.get("../php/getEmails.php?email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + encodeURIComponent(window.localStorage.getItem("salt")), function(data){
						//success
						if(data.indexOf("true|") == 0){
							var emails = JSON.parse(data.replace("true|", ""));
							var allEmails = [];
							var authorityEmails = [];
							for (var i in emails) {
								if (emails.hasOwnProperty(i)) {
									// do stuff
									allEmails[allEmails.length] = emails[i]["email"];
									if(emails[i]["authority"]){
										authorityEmails[authorityEmails.length] = emails[i]["email"];
									}
								}
							}
							$("#everyoneCount")[0].innerHTML = allEmails.length;
							$("#siteAuthoritiesCount")[0].innerHTML = authorityEmails.length;
							$("#everyone")[0].value = allEmails.join(", ");
							$("#siteAuthorities")[0].value = authorityEmails.join(", ");
							$("#getEmailsLoading")[0].style.display = "none";
							$("#emails")[0].style.display = "block";
						}
						else{
							var getEmailsError = data.replace("false|", "");
							queueNotice("error", getEmailsError);
							$("#getEmailsSetting").stop().fadeOut();
							if(getEmailsError == "Your log in dissolved. Maybe you logged in on another device."){
								logOut();
							}
						}
					})
					.fail(function(){
						//error
						queueNotice("error", "Your request to get emails from the Caterpillars Count! database did not process. You may have a weak internet connection, or our servers might be busy. Please refresh the page to try again.");
						$("#getEmailsSetting").stop().fadeOut();
					});
				}
			});
			
			function expandTextarea(textareaElement){
				textareaElement = $(textareaElement)[0];
				textareaElement.style.overflow = "scroll";
				$(textareaElement).stop().animate({height:'150px'});
				$(textareaElement.parentNode).find('.textareaOtherLinesCover').stop().fadeOut();
			}
			
			function compressTextarea(textareaElement){
				textareaElement = $(textareaElement)[0];
				textareaElement.style.overflow = "hidden";
				$(textareaElement).stop().animate({height:'54px', scrollTop:'0'});
				$(textareaElement.parentNode).find('.textareaOtherLinesCover').stop().fadeIn();
			}
			
			function closeAllSettings(){
				$(".setting").css({border:"2px solid #eee"});
				$(".settingBody").stop().animate({maxHeight:"0px"});
				$(".settingTitle").stop().animate({backgroundColor:"#f7f7f7", color:"#aaa"});
			}
			
			function toggleSetting(setting){
				var settingBody = $(setting).find(".settingBody").eq(0)[0];
				
				//reset all
				closeAllSettings();
				
				if(settingBody.style.maxHeight == "" || settingBody.style.maxHeight == "0px"){
					$(setting).css({border:"0px none transparent"});
					$(settingBody).stop().animate({maxHeight:"500px"});
					$(setting).find(".settingTitle").eq(0).stop().animate({backgroundColor:"#444", color:"#fff"});
				}
				else{
					$(settingBody).stop().animate({maxHeight:"0px"});
				}
			}
			
			function resetNewPasswords(){
				//clear password inputs in #changePassword and focus on the first one
				$("#changePassword input").eq(0)[0].blur();
				$("#changePassword input").eq(1)[0].blur();
				$("#changePassword input").eq(2)[0].blur();
				
				$("#changePassword input").eq(1)[0].value = "";
				$("#changePassword input").eq(2)[0].value = "";
				$("#changePassword input").eq(1)[0].focus();
			}
			
			var settingNewPassword = false;
			function setNewPassword(){
				//change the password and, if successful, update the locally saved version of the password and close the drop down
				if(!settingNewPassword){
					var currentPassword = $("#changePassword input").eq(0)[0].value;
					var newPassword = $("#changePassword input").eq(1)[0].value;
					var confirmNewPassword = $("#changePassword input").eq(2)[0].value;
					
					if(newPassword != confirmNewPassword){
						queueNotice("error", "New passwords must match.");
						resetNewPasswords();
						return false;
					}
					else if(newPassword == currentPassword){
						queueNotice("error", "New password must be different than current password.");
						resetNewPasswords();
						return false;
					}
					
					settingNewPassword = true;
					setLoadingButton($("#changePasswordButton")[0], "Change password", true);
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							settingNewPassword = false;
							setLoadingButton($("#changePasswordButton")[0], "Change password", false);
							if(this.responseText.indexOf("false|") != 0){
								window.localStorage.removeItem("salt");
								window.localStorage.setItem("salt", this.responseText);
								$("#changePassword input").eq(0)[0].value = "";
								$("#changePassword input").eq(1)[0].value = "";
								$("#changePassword input").eq(2)[0].value = "";
								queueNotice("confirmation", "Password changed.");
								closeAllSettings();
							}
							else{
								var setNewPasswordError = this.responseText.replace("false|", "");
								queueNotice("error", setNewPasswordError);
								if(setNewPasswordError == "New password must be at least 8 characters with no spaces."){
									resetNewPasswords();
								}
								else if(setNewPasswordError == "Current password is incorrect."){
									$("#changePassword input").eq(0)[0].blur();
									$("#changePassword input").eq(1)[0].blur();
									$("#changePassword input").eq(2)[0].blur();
									
									$("#changePassword input").eq(0)[0].value = "";
									$("#changePassword input").eq(0)[0].focus();
								}
								else if(setNewPasswordError == "Your log in dissolved. Maybe you logged in on another device."){
									$("#changePassword input").eq(0)[0].blur();
									$("#changePassword input").eq(1)[0].blur();
									$("#changePassword input").eq(2)[0].blur();
									
									logOut();
								}
							}
						}
					};
					xhttp.open("GET", "../php/changePassword.php?currentPassword=" + encodeURIComponent(currentPassword) + "&newPassword=" + encodeURIComponent(newPassword) + "&email=" + encodeURIComponent(window.localStorage.getItem("email")), false);
					xhttp.send();
				}
			}
		</script>
	</head>
	<body>
		<div id="managerRequest">
			<div id="managerRequestMessage"></div>
			<div id="managerRequestButtons">
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('deny');">Deny</div>
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('approve');">Accept</div>
			</div>
		</div>
		<div id="error" onclick="hideNotice();"></div>
		<div id="confirmation" onclick="hideNotice();"></div>
		<div id="alert" onclick="hideNotice();"></div>
		<div id="promptInteractionBlock"></div>
		<div id="noticeInteractionBlock" onclick="hideNotice();"></div>
		<div id="confirm">
			<div></div>
			<div>
				<button>OK</button>
				<button>Cancel</button>
				<div class="clearBoth"></div>
			</div>
		</div>
		
		<div id="splash">
			<div id="splashImage"></div>
			<div id="splashOverlay">
				<div id="splashIntroText">Welcome to</div>
				<div id="splashMainText">Caterpillars Count!</div>
				<button id="splashButton" onclick="this.blur();scrollToPanel(1);">View settings</button>
			</div>
		</div>
		<header>
			<h1><a href="../">Caterpillars Count!</a></h1>
			<div id="hamburger" onclick="toggleNav();">
				<div></div>
				<div></div>
				<div></div>
			</div>
			<div id="navKnockDown" class="clearBoth"></div>
			<nav class="loadingNav">
				<ul>
					<li onclick="accessSubMenu(this);">
						<span>Participate</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../getStarted">Get Started</a></li>
							<li><a href="../conductASurvey">Conduct a Survey</a></li>
							<li><a href="../submitObservations">Submit Observations</a></li>
							<li><a href="../hostASurveySite">Host a Survey Site</a></li>
							<li><a href="../resources">Resources</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Explore</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../mapsAndGraphs">Maps & Graphs</a></li>
							<li><a href="../recentObservations">Recent Observations</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Learn</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../identificationSkills">Identification Skills</a></li>
							<li><a href="../forEducators">For Educators</a></li>
							<li><a href="../faq">FAQ</a></li>
						</ul>
					</li>
					<li onclick="window.location = '../signIn';">
						<span>Sign In</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../createNewSite">Create New Site</a></li>
							<li><a href="../manageMySites">Manage My Sites</a></li>
							<li><a href="../settings">Settings</a></li>
							<li><a href="" onclick="logOut();">Sign Out</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<div id="navBack" onclick="resetMenu(false);">&#10094;</div>
		</header>
		<main>
			<div class="panel">
				<h2>Settings</h2>
				<div class="content">
					<div class="setting">
						<div class="settingTitle" onclick="toggleSetting(this.parentNode);">Change password</div>
						<div class="settingBody">
							<div id="changePassword">
								<input type="password" placeholder="current password"/>
								<input type="password" placeholder="new password"/>
								<input type="password" placeholder="confirm new password"/>
								<button onclick="setNewPassword();" id="changePasswordButton">Change password</button>
							</div>
						</div>
					</div>
					<div class="setting superUsersOnly" id="getEmailsSetting">
						<div class="settingTitle" onclick="toggleSetting(this.parentNode);">Get user emails</div>
						<div class="settingBody">
							<div>
								<div id="getEmailsLoading">
									<img src="../images/rolling.svg"/>
								</div>
								<div id="emails">
									<div class="group">
										<div class="inputTitle">Everyone (<span id="everyoneCount"></span>):</div>
										<div class="textareaHolder">
											<textarea id="everyone" onclick="this.setSelectionRange(0, 999999999999);" onfocus="expandTextarea(this);" onblur="compressTextarea(this);"></textarea>
											<div class="textareaOtherLinesCover"></div>
										</div>
									</div>
									<div class="group">
										<div class="inputTitle">Site authorities only (<span id="siteAuthoritiesCount"></span>):</div>
										<div class="textareaHolder">
											<textarea id="siteAuthorities" onclick="this.setSelectionRange(0, 999999999999);" onfocus="expandTextarea(this);" onblur="compressTextarea(this);"></textarea>
											<div class="textareaOtherLinesCover"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
		<footer>
			<div>Part of the <a href="http://pheno-mismatch.org" target="_blank">Pheno Mismatch</a> project funded by the National Science Foundation</div>
			
			<div><img src="../images/unc.png"/></div><div>
				<a target="_blank" href="https://www.facebook.com/Caterpillars-Count-1854259101283140/"><img src="../images/facebook.png" alt="facebook"/></a><a target="_blank" href="https://twitter.com/CaterpillarsCt"><img src="../images/twitter.png" alt="twitter"/></a>
			</div>
			
			<div>Contact us: <a href="mailto:caterpillarscount@gmail.com">caterpillarscount@gmail.com</a></div>
		</footer>
	</body>
</html>
