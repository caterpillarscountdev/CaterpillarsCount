<html>
	<head>
		<!-- Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113319025-1"></script>
		<script>
  			window.dataLayer = window.dataLayer || [];
  			function gtag(){dataLayer.push(arguments);}
  			gtag('js', new Date());
			gtag('config', 'UA-113319025-1');
		</script>
		<!-- End of Google Analytics -->

		<title>Oversee Managers | Caterpillars Count!</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Fanwood+Text:400i" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
		<link href="../css/template.css" rel="stylesheet">
		<script src="../js/template.js?v=1"></script>
		<style>
			#topSection{
				background:rgba(0,0,0,0.015);
				padding:20px;
				border-radius:4px 4px 0px 0px;
				display:none;
			}

			.inputTitle{
				font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
				color:#666;
				text-transform:uppercase;
				font-size:14px;
			}

			#newManagerEmailDiv{
				position:relative;
				border:1px solid #eee;
				border-bottom:2px solid #ddd;
				margin:5px 0px;
				border-radius:4px;
				overflow:hidden;
			}

			#newManagerEmailDiv input{
				border:0px none transparent;
				margin:0px;
			}

			#newManagerEmailDiv button{
				position:absolute;
				top:0px;
				right:0px;
				margin:0px;
				border-radius:0px;
				padding:14px 30px;
			}

			#managers{
				border-radius:0px 0px 4px 4px;
				overflow:hidden;
				font-family: 'Roboto Slab', serif;
				color:#999;
				font-size:18px;
				word-break:break-word;
			}

			#managers>div{
				border-top:1px solid rgba(0,0,0,0.03);
				padding:20px 78px 20px 20px;
				background:rgba(0,0,0,0.03);
				position:relative;
			}

			#managers>div>div{
				position:absolute;
				top:50%;
				right:20px;
				width:30px;
				font-size:29px;
				margin-top:-19px;
				height:38px;
				text-align:center;
				cursor:pointer;
				background-position:center;
				background-size:contain;
				background-repeat:no-repeat;
			}
			
			#managers>div>img{
				height: 16px;
				position: absolute;
				top: 50%;
				right: 53px;
				margin-top: -8px;
				cursor:pointer;
			}
		</style>
		<script>
			requireLogIn();

			$(document).ready(function(){
				loadBackgroundImage($("#splashImage"), "../images/splash.png");
				loadManagers();
			});

			function email(emailParts){
				window.location = "mailto:" + emailParts.join('@');
			}
			
			var togglingCreatorPermissions = [];
			function toggleCreatorPermissions(managerID){
				if(togglingCreatorPermissions.indexOf(managerID.toString()) == -1){
					togglingCreatorPermissions[togglingCreatorPermissions.length] = managerID.toString();
					
					var shouldHaveCreatorPermissions = ($("#manager" + Number(managerID)).find("img").eq(0)[0].src.indexOf("Outline") > -1);
					$.get("../php/setManagerCreatorPermissions.php?siteID=" + encodeURIComponent(window.location.toString().substring(window.location.toString().indexOf("?s=") + 3)) + "managerID=" + Number(managerID) + "&creatorPermissions=" + shouldHaveCreatorPermissions + "email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + window.localStorage.getItem("salt"), function(data){
						//success
						if(data.indexOf("true|") == 0){
							if(shouldHaveCreatorPermissions){
								$("#manager" + Number(managerID)).find("img").eq(0)[0].src = "../images/crownFilled.png";
							}
							else{
								$("#manager" + Number(managerID)).find("img").eq(0)[0].src = "../images/crownOutline.png";
							}
						}
						else{
							queueNotice("error", data.replace("false|", ""));
						}
					})
					.fail(function(){
						//error
						queueNotice("error", "Your request did not process. You may have a weak internet connection, or our servers might be busy. Please try again.");
					})
					.always(function(){
						//complete
						var managerIDIndex = togglingCreatorPermissions.indexOf(managerID.toString());
						if (managerIDIndex > -1) {
							togglingCreatorPermissions.splice(managerIDIndex, 1);
						}
					});
				}
			}

			function loadManagers(){
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						if(this.responseText.indexOf("true|") == 0){
							var managers = JSON.parse(this.responseText.replace("true|", ""));
							if(managers === null){managers = [];}

							var htmlToAdd = "";
							for(var i = 0; i < managers.length; i++){
								htmlToAdd += "<div id=\"manager" + managers[i]["managerID"] + "\">";
								htmlToAdd += 	"<span class=\"highlighted pointer underline\" onclick=\"email(['" + managers[i]["email"].split("@")[0] + "', '" + managers[i]["email"].split("@")[1] + "']);\">" + managers[i]["fullName"] + "</span>";
								htmlToAdd += "<img src=\"../images/crownOutline.png\" onclick=\"toggleCreatorPermissions('" + managers[i]["managerID"] + "');\"/>";
								if(managers[i]["status"] == "Approved"){
									htmlToAdd += "<div onclick=\"promptConfirm('Are you sure you want to terminate " + managers[i]["fullName"] + "\\'s management position at this site? ', 'Nevermind.', 'Continue. I am sure!', function(){}, function(){terminate('" + managers[i]["managerID"] + "');});\">&times;</div>";
								}
								else if(managers[i]["status"] == "Pending"){
									htmlToAdd += " (request pending)<div onclick=\"promptConfirm('Are you sure you want to cancel your request for " + managers[i]["fullName"] + "\\'s management services at this site? ', 'Nevermind.', 'Continue. I am sure!', function(){}, function(){terminate('" + managers[i]["managerID"] + "');});\">&times;</div>";
								}
								else{
									htmlToAdd += " (request denied)<div onclick=\"terminate('" + managers[i]["managerID"] + "');\">&times;</div>";
								}
								htmlToAdd += "</div>";
							}
							if(htmlToAdd == ""){
								$("#topSection")[0].style.borderRadius = "4px";
							}
							$("#topSection")[0].style.display = "block";
							$("#managers")[0].innerHTML = htmlToAdd;
							updateManagers();
						}
						else{
							$("#managers")[0].innerHTML = "";
							var loadManagersError = this.responseText.replace("false|", "");
							queueNotice("error", loadManagersError);
							if(loadManagersError == "You did not create this site, so you cannot oversee its management."){
								$(".tagline").eq(0)[0].innerHTML = "You did not create this site, so you cannot oversee its management. <a href=\"../manageMySites\">Click here to go back to your Manage My Sites page</a>."
							}
							if(loadManagersError == "Your log in dissolved. Maybe you logged in on another device."){
								logOut();
							}
						}
					}
				};
				xhttp.open("GET", "../php/getManagers.php?siteID=" + encodeURIComponent(window.location.toString().substring(window.location.toString().indexOf("?s=") + 3)) + "&email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + window.localStorage.getItem("salt"), true);
				xhttp.send();
			}
			function updateManagers(){
				$.get("../php/getManagers.php?siteID=" + encodeURIComponent(window.location.toString().substring(window.location.toString().indexOf("?s=") + 3)) + "&email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + window.localStorage.getItem("salt"), function(data){
					//success
					if(data.indexOf("true|") == 0){
						var managers = JSON.parse(data.replace("true|", ""));
						if(managers === null){managers = [];}

						//check if each status on page reflects status from back end
						for(var i = 0; i < managers.length; i++){
							if($("#manager" + managers[i]["managerID"]).length > 0){
								var managerDiv = $("#manager" + managers[i]["managerID"])[0];
								if(managers[i]["status"] == "Approved" && managerDiv.innerHTML.indexOf("(request") > 0){
									//approved but not showing approved
									loadManagers();
								}
								else if(managers[i]["status"] == "Pending" && managerDiv.innerHTML.indexOf("(request pending)") == -1){
									//pending but not showing pending
									loadManagers();
								}
								else if(managers[i]["status"] == "Denied" && managerDiv.innerHTML.indexOf("(request denied)") == -1){
									//denied but not showing denied
									loadManagers();
								}
							}
							else{
								//somehow missing manager on page
								loadManagers();
							}
						}

						//check if there is one on the page that should not be on the page
						var managerDivs = $("#managers>div");
						for(var i = 0; i < managerDivs.length; i++){
							var idFromPage = Number(managerDivs.eq(i)[0].id.replace("manager", ""));
							var verified = false;
							for(var j = 0; j < managers.length; j++){
								if(Number(managers[j]["managerID"]) == idFromPage){
									verified = true;
									break;
								}
							}
							if(!verified){
								loadManagers();
							}
						}
					}
				})
				.always(function() {
					setTimeout(updateManagers, 1000);
				});
			}

			function sendManagerRequest(){
				var newManagerEmail = $("#newManagerEmail")[0].value.replace(/ /g,"");
				$("#newManagerEmail")[0].value = "";
				if(newManagerEmail == ""){
					queueNotice("error", "Enter the email address of the user whose services you'd like to request.");
				}
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						if(this.responseText.indexOf("true") == 0){
							var newManager = JSON.parse(this.responseText.replace("true|", ""));
							$("#topSection")[0].style.borderRadius = "";

							if($("#manager" + newManager["managerID"]).length > 0){
								var innerHTMLToReplaceWith = "<span class=\"highlighted pointer underline\" onclick=\"email(['" + newManager["email"].split("@")[0] + "', '" + newManager["email"].split("@")[1] + "']);\">" + newManager["fullName"] + "</span>";
								innerHTMLToReplaceWith += " (request pending)<div onclick=\"promptConfirm('Are you sure you want to cancel your request for " + newManager["fullName"] + "\\'s management services at this site?', 'Nevermind.', 'Continue. I am sure!', function(){}, function(){terminate('" + newManager["managerID"] + "');});\">&times;</div>";
								$("#manager" + newManager["managerID"])[0].innerHTML = innerHTMLToReplaceWith;
							}
							else{
								var htmlToAdd = "<div id=\"manager" + newManager["managerID"] + "\">";
								htmlToAdd += "<span class=\"highlighted pointer underline\" onclick=\"email(['" + newManager["email"].split("@")[0] + "', '" + newManager["email"].split("@")[1] + "']);\">" + newManager["fullName"] + "</span>";
								htmlToAdd += " (request pending)<div onclick=\"promptConfirm('Are you sure you want to cancel your request for " + newManager["fullName"] + "\\'s management services at this site?', 'Nevermind.', 'Continue. I am sure!', function(){}, function(){terminate('" + newManager["managerID"] + "');});\">&times;</div>";
								htmlToAdd += "</div>";
								$("#managers").append(htmlToAdd);
							}
							queueNotice("confirmation", "You have requested " + newManager["fullName"] + "'s services as a manager for this site. Please keep in mind that " + newManager["fullName"].split(" ")[0] + " must approve this request before actually becoming an active manager for the site.");
						}
						else{
							var loadManagersError = this.responseText.replace("false|", "");
							queueNotice("error", loadManagersError);
							if(loadManagersError == "Your log in dissolved. Maybe you logged in on another device."){
								logOut();
							}
						}
					}
				};
				xhttp.open("GET", "../php/sendManagerRequest.php?siteID=" + encodeURIComponent(window.location.toString().substring(window.location.toString().indexOf("?s=") + 3)) + "&managerEmail=" + encodeURIComponent(newManagerEmail) + "&email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + window.localStorage.getItem("salt"), true);
				xhttp.send();
			}

			function terminate(managerID){
				$("#manager" + Number(managerID))[0].getElementsByTagName("div")[0].innerHTML = "";
				$("#manager" + Number(managerID))[0].getElementsByTagName("div")[0].style.backgroundImage = "url('../images/rolling.svg')";
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						if(this.responseText.indexOf("true|") == 0){
							$("#manager" + Number(managerID))[0].outerHTML = "";
							if($("#managers>div").length == 0){
								$("#topSection")[0].style.borderRadius = "4px";
							}
						}
						else{
							$("#manager" + Number(managerID))[0].getElementsByTagName("div")[0].innerHTML = "&times;";
							$("#manager" + Number(managerID))[0].getElementsByTagName("div")[0].style.backgroundImage = "url('#')";
							var terminateError = this.responseText.replace("false|", "");
							queueNotice("error", terminateError);
							if(terminateError == "Your log in dissolved. Maybe you logged in on another device."){
								logOut();
							}
						}
					}
				};
				xhttp.open("GET", "../php/terminateManager.php?siteID=" + encodeURIComponent(window.location.toString().substring(window.location.toString().indexOf("?s=") + 3)) + "&managerID=" + Number(managerID) + "&email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + window.localStorage.getItem("salt"), true);
				xhttp.send();
			}
		</script>
	</head>
	<body>
		<div id="managerRequest">
			<div id="managerRequestMessage"></div>
			<div id="managerRequestButtons">
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('deny');">Deny</div>
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('approve');">Accept</div>
			</div>
		</div>
		<div id="error" onclick="hideNotice();"></div>
		<div id="confirmation" onclick="hideNotice();"></div>
		<div id="alert" onclick="hideNotice();"></div>
		<div id="promptInteractionBlock"></div>
		<div id="noticeInteractionBlock" onclick="hideNotice();"></div>
		<div id="confirm">
			<div></div>
			<div>
				<button>OK</button>
				<button>Cancel</button>
				<div class="clearBoth"></div>
			</div>
		</div>

		<div id="splash">
			<div id="splashImage"></div>
			<div id="splashOverlay">
				<div id="splashIntroText">Welcome to</div>
				<div id="splashMainText">Caterpillars Count!</div>
				<button id="splashButton" onclick="this.blur();scrollToPanel(1);">Oversee Managers</button>
			</div>
		</div>
		<header>
			<h1><a href="../">Caterpillars Count!</a></h1>
			<div id="hamburger" onclick="toggleNav();">
				<div></div>
				<div></div>
				<div></div>
			</div>
			<div id="navKnockDown" class="clearBoth"></div>
			<nav class="loadingNav">
				<ul>
					<li onclick="accessSubMenu(this);">
						<span>Participate</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../getStarted">Get Started</a></li>
							<li><a href="../conductASurvey">Conduct a Survey</a></li>
							<li><a href="../submitObservations">Submit Observations</a></li>
							<li><a href="../hostASurveySite">Host a Survey Site</a></li>
							<li><a href="../resources">Resources</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Explore</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../mapsAndGraphs">Maps & Graphs</a></li>
							<li><a href="https://www.inaturalist.org/observations?place_id=any&subview=grid&user_id=caterpillarscount&verifiable=any">Recent Observations</a></li>
							<li><a href="../dataDownload">Data Download</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Learn</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../identificationSkills">Identification Skills</a></li>
							<li><a href="../forEducators">For Educators</a></li>
							<li><a href="../faq">FAQ</a></li>
						</ul>
					</li>
					<li onclick="window.location = '../news';">
						<span>News</span>
					</li>
					<li onclick="window.location = '../signIn';">
						<span>Sign In</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../createNewSite">Create New Site</a></li>
							<li><a href="../manageMySites">Manage My Sites</a></li>
							<li><a href="../manageMySurveys">Manage My Surveys</a></li>
							<li><a href="../settings">Settings</a></li>
							<li><a href="" onclick="logOut();">Sign Out</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<div id="navBack" onclick="resetMenu(false);">&#10094;</div>
		</header>
		<main>
			<div class="panel">
				<h2>Oversee Managers</h2>
				<div class="tagline">By default, your managers can do anything with this site that you can do, with the exception of editing the list of this site's managers. If you've added a manager that you would like to promote to be able to do this, click the crown icon by their name to grant them that authoriy.</div>
				<div class="content">
					<div id="topSection">
						<div class="inputTitle">Add a new site manager:</div>
						<div id="newManagerEmailDiv">
							<input type="text" placeholder="user's email" id="newManagerEmail" onkeypress="if(event.which == 13){this.blur();sendManagerRequest();}"/>
							<button onclick="sendManagerRequest();">+</button>
						</div>
					</div>
					<div id="managers">
						<div style="border-radius:4px;overflow:hidden;text-align:center;padding:20px;border-top:0px none transparent;"><img src="../images/rolling.svg" style="height:30px;"/></div>
					</div>
					<div style="text-align:center;margin-bottom:20px;margin-top:40px;" class="underline"><a href="../manageMySites" style="color:#ccc;font-size:16px;font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;">Cancel</a></div>
				</div>
			</div>
		</main>
		<footer>
			<div>Part of the <a href="http://pheno-mismatch.org" target="_blank">Pheno Mismatch</a> project funded by the National Science Foundation</div>

			<div><img src="../images/unc.png"/></div><div>
				<a target="_blank" href="https://www.facebook.com/Caterpillars-Count-1854259101283140/"><img src="../images/facebook.png" alt="facebook"/></a><a target="_blank" href="https://twitter.com/CaterpillarsCt"><img src="../images/twitter.png" alt="twitter"/></a>
			</div>

			<div>Contact us: <a href="mailto:caterpillarscount@gmail.com">caterpillarscount@gmail.com</a></div>

			<div>View our <a href="../privacyPolicy">privacy policy</a></div>
		</footer>
	</body>
</html>
