<html>
	<head>
		<!-- Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113319025-1"></script>
		<script>
  			window.dataLayer = window.dataLayer || [];
  			function gtag(){dataLayer.push(arguments);}
  			gtag('js', new Date());
			gtag('config', 'UA-113319025-1');
		</script>
		<!-- End of Google Analytics -->

                <link rel="manifest" href="/manifest.json" />

		<title>Edit Survey Plants | Caterpillars Count!</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="apple-touch-icon-precomposed" sizes="57x57" href="../images/favicon/apple-touch-icon-57x57.png" />
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../images/favicon/apple-touch-icon-114x114.png" />
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../images/favicon/apple-touch-icon-72x72.png" />
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../images/favicon/apple-touch-icon-144x144.png" />
		<link rel="apple-touch-icon-precomposed" sizes="60x60" href="../images/favicon/apple-touch-icon-60x60.png" />
		<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../images/favicon/apple-touch-icon-120x120.png" />
		<link rel="apple-touch-icon-precomposed" sizes="76x76" href="../images/favicon/apple-touch-icon-76x76.png" />
		<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../images/favicon/apple-touch-icon-152x152.png" />
		<link rel="icon" type="image/png" href="../images/favicon/favicon-196x196.png" sizes="196x196" />
		<link rel="icon" type="image/png" href="../images/favicon/favicon-96x96.png" sizes="96x96" />
		<link rel="icon" type="image/png" href="../images/favicon/favicon-32x32.png" sizes="32x32" />
		<link rel="icon" type="image/png" href="../images/favicon/favicon-16x16.png" sizes="16x16" />
		<link rel="icon" type="image/png" href="../images/favicon/favicon-128.png" sizes="128x128" />
		<meta name="msapplication-TileColor" content="transparent" />
		<meta name="msapplication-TileImage" content="../images/favicon/mstile-144x144.png" />
		<meta name="msapplication-square70x70logo" content="../images/favicon/mstile-70x70.png" />
		<meta name="msapplication-square150x150logo" content="../images/favicon/mstile-150x150.png" />
		<meta name="msapplication-wide310x150logo" content="../images/favicon/mstile-310x150.png" />
		<meta name="msapplication-square310x310logo" content="../images/favicon/mstile-310x310.png" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.3/jquery-ui.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Fanwood+Text:400i" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
		<link href="../css/maps.css?v=2" rel="stylesheet">
		<link href="../css/template.css" rel="stylesheet">
		<script src="../js/template.js?v=3"></script>
		<link href="../css/checkbox.css?v=2" rel="stylesheet">
		<script src="../js/checkbox.js?v=2"></script>
		<style>
			#map-canvas {
              			height: 270px;
              			margin:10px 0px;
              			border-radius:4px;
              			overflow:hidden;
            		}
  
			ul.ui-autocomplete{
				width:753px;
				box-sizing:border-box;
				padding:0px;
			}
			@media screen and (max-width: 999px) {
				ul.ui-autocomplete{
					width:100%;
					padding:0px 122px 0px 125px;
				}
			}
			@media screen and (max-width: 770px) {
				ul.ui-autocomplete{
					padding:0px 42px 0px 45px;
				}
			}
			ul.ui-autocomplete>li{
				background:#888;/*#a1c3ff;*/
				color:#fff;
				font-size:18px;
				padding:5px 25px;
				box-sizing:border-box;
				list-style-type:none;
			}

			ul.ui-autocomplete>li:last-of-type{
				border-radius:0px 0px 4px 4px;
				overflow:hidden;
				border-bottom:2px solid rgba(0,0,0,.2);
			}

			.ui-helper-hidden-accessible{
				display:none;
			}

			.ui-menu-item{
				font-size:14px;
				font-family: 'Roboto Slab', serif;
				cursor:pointer;
			}

			#saveAllButton, #addNewCircle{
				display:none;
			}

			.circle{
				margin:20px 0px;
				border-radius:4px;
			        overflow:hidden;
				border:2px solid #eee;
			}

			.circleTitle{
				font-size:20px;
				background:#f7f7f7;
				color:#aaa;
				padding:20px;
				cursor:pointer;
                        }
		        .checkboxTable {
			    color:#666;
                        }
                        .moveMapLabel {
                            padding-top: 3px;
                            color: #666;
                        }
                        .moveMapQuestion {
                            padding-top: 3px;
                            color: #666;
                            display: none;
                        }

                        .hideForNew {
                            display: none;
                        }
                                
			.plants{
				font-size:16px;
				background:#f7f7f7;
				max-height:0px;
				overflow:hidden;
				border-right:2px solid #eee;
				border-bottom:2px solid #eee;
			}
			.circleTitle, .plants, .checkboxTable {
				font-family: 'Roboto Slab', serif;
			}

			.noticeImage{
				margin:4px 8px 4px 0px;
				height:18px;
				float:right;
			}

                        .gm-style-iw {
                          background-color: #f7f7f7;
                        }


                        .fieldsSpecies {}
                        .fieldsLocation {
                            display:none;
                        }

                        .plantTabs {
                            margin: 1em;
                        }

                        .plantTab {
                            color: #666;
                            padding: 0.5em;
                            margin-top: 0.5em;
                            margin-right: 2em;
                            border-bottom: 3px solid #666;
                        }

                        .plantTab.selected {
                            background-color: #fff;
                        }
                 
                 
		        .plant{
		            border-left:5px solid transparent;
		            padding:20px;
		        }

			.plant:nth-of-type(1), .plant:nth-of-type(1) .plantTab.selected {
				border-color:#ff7575;
			}

		        .plant:nth-of-type(2), .plant:nth-of-type(2) .plantTab.selected {
		                border-color:#75b3ff;
		        }

		        .plant:nth-of-type(3), .plant:nth-of-type(3) .plantTab.selected {
		                border-color:#5abd61;
		        }
                 
		        .plant:nth-of-type(4), .plant:nth-of-type(4) .plantTab.selected {
		                border-color:#ffc875;
		        }

		        .plant:nth-of-type(5), .plant:nth-of-type(5) .plantTab.selected {
		                border-color:#9175ff;
		        }

			.code{
				font-weight:bold;
				font-size:120%;
			}

			.code img{
				height:20px;
				margin-right:7px;
				margin-bottom:-3px;
			}

			.editableFieldTitle{
				color:#666;
				margin-top:10px;
			}
			
			.checkboxTableHolder{
				position:relative;
			}
			
			.checkboxTableOverlay{
				position:absolute;
				top:0px;
				left:0px;
				width:100%;
				height:100%;
			}

			#addNewCircle{
				margin:20px 0px;
				border-radius:4px;
				overflow:hidden;
				border:2px solid #eee;
				border-bottom:4px solid #eee;
				font-size:20px;
				background:#f7f7f7;
				color:#aaa;
				padding:20px;
				cursor:pointer;
				font-family: 'Roboto Slab', serif;
				position:relative;
			}

			#addNewCircle .plusImage {
			    height: 34px;
			    width: 34px;
			    background-size: contain;
			    background-repeat: no-repeat;
			    background-position: center;
			    display: inline-block;
			    opacity: .4;
			    position: absolute;
			    right: 20px;
			    top: 16px;
			}

			@media screen and (max-width: 620px) {
				main button{
					width:100%;
				}
			}
		</style>
		<script>
		 requireLogIn();
		 
		 var plantSpeciesList;
                 getPlantSpeciesList().then((v) => plantSpeciesList = v );
		 var coniferSpeciesList;
                 getConiferSpeciesList().then((v) => coniferSpeciesList = v );
		 
		 $(document).ready(function(){
		     loadBackgroundImage($("#splashImage"), "../images/splash.png");
				loadCircles();
			});
			$(window).resize(function(){
				$('.ui-autocomplete').css({display:"none"});
			});

			function inArrayIgnoreCaseAndWhitespace(needle, haystack){
				for(var i = 0; i < haystack.length; i++){
					if(haystack[i].replace(/\s\s+/g, ' ').trim().toLowerCase() == needle.replace(/\s\s+/g, ' ').trim().toLowerCase()){return true;}
				}
				return false;
			}

			function getWordAtIndex(str, index){
				var left = str.slice(0, index + 1).search(/\S+$/);
				var right = str.slice(index).search(/\s/);
				if (right < 0) {return str.slice(left);}
				return str.slice(left, right + index);
			}
			function attachAutoCompleteToInput(inputElement, sourceList, bindSetConifer){
				bindSetConifer = bindSetConifer || false;
				
				var autoCompleteOptions = {
					minLength: 2,
					source: function(request, response) {
						var results = $.ui.autocomplete.filter(sourceList, request.term);
						results.sort(function(a, b){
							a = a.toLowerCase();
							b = b.toLowerCase();
							var term = request.term.toLowerCase();

							//how close to the beginning of a word
							var aWord = getWordAtIndex(a, a.indexOf(term));
							var bWord = getWordAtIndex(b, b.indexOf(term));
							var diff = aWord.indexOf(term) - bWord.indexOf(term);
							if(diff !== 0) return diff;

							//tiebreaker prioritize first word results
							var aFirstWord = a.split(" ").indexOf(aWord) == 0;
							var bFirstWord = b.split(" ").indexOf(bWord) == 0;
							if(aFirstWord && !bFirstWord) return -1;
							else if(bFirstWord && !aFirstWord) return 1;

							//tiebreaker is how close to the beginning of the string
							//var diff = a.indexOf(term) - b.indexOf(term);
							//if(diff !== 0){return diff;}

							//tiebreaker alphabetical
							if(a < b) return -1;
    						if(a > b) return 1;
    						return 0;
						});
						response(results);
						//response(results.slice(0, 10));
					},
					open: function(event, ui) {
						var idNumber = ($("input").index(this) + 1);
						$('#ui-id-' + idNumber).off('menufocus hover mouseover mouseenter');

            					var left = $('#ui-id-' + idNumber).position().left;
						var leftOffset = 0;
						if($(window).width() < 771){
							leftOffset = 45;
						}
						else if($(window).width() < 1000){
							leftOffset = 125;
						}
        					$('#ui-id-' + idNumber).css({left: (left - leftOffset) + "px"});
					}
				};
				
				if(bindSetConifer){
					autoCompleteOptions["close"] = function(event, ui){
						setConifer(this);
					}
				}
				
				$(inputElement).autocomplete(autoCompleteOptions);
			}
			
			function isKnownConifer(plantSpeciesName){
				plantSpeciesName = plantSpeciesName.replace(/[^A-Za-z]+/g," ").replace(/\s\s+/g, ' ').trim().toLowerCase();
				
				if(plantSpeciesName == ""){
					return false;
				}
				
				if(coniferSpeciesList.indexOf(plantSpeciesName) > -1){
					return true;
				}
				
				var prefixes = ["abies", "chamaecyparis", "juniperus", "larix", "picea", "pinus", "pseudotsuga", "taxodium", "taxus", "thuja", "tsuga"];
				for(var i = 0; i < prefixes.length; i++){
					if((" " + plantSpeciesName).indexOf(" " + prefixes[i])> -1){
						return true;
					}
				}
				
				var suffixes = ["fir", "cedar", "juniper", "larch", "spruce", "pine", "cypress", "yew", "hemlock"];
				var plantSpeciesNameParts = plantSpeciesName.split(" ");
				return suffixes.indexOf(plantSpeciesNameParts[plantSpeciesNameParts.length - 1]) > -1;
			}
			
			lastManualConiferSettings = {};
			function setConifer(plantSpeciesInput){
				//this function is called whenever value of #plantSpecies changes
				var plantSpecies = plantSpeciesInput.value;
				
				//if we recognize it
				if(isKnownConifer(plantSpecies)){
					//check and gray out
					$("#checkboxTableOverlay" + plantSpeciesInput.id).css({display: "block"});
					$("#checkboxTable" + plantSpeciesInput.id).css({opacity: ".5"});
					checkCheckbox($("#coniferCheckbox" + plantSpeciesInput.id));
				}
				else if(inArrayIgnoreCaseAndWhitespace(plantSpecies, plantSpeciesList)){
					//uncheck and gray out
					$("#checkboxTableOverlay" + plantSpeciesInput.id).css({display: "block"});
					$("#checkboxTable" + plantSpeciesInput.id).css({opacity: ".5"});
					uncheckCheckbox($("#coniferCheckbox" + plantSpeciesInput.id));
				}
				else{
					//ungray
					$("#checkboxTableOverlay" + plantSpeciesInput.id).css({display: "none"});
					$("#checkboxTable" + plantSpeciesInput.id).css({opacity: "1"});
					
					//revert to last manual selection
					if(lastManualConiferSettings[plantSpeciesInput.id] === true){
						if(!checkboxIsChecked($("#coniferCheckbox" + plantSpeciesInput.id))){
							checkCheckbox($("#coniferCheckbox" + plantSpeciesInput.id));
						}
					}
					else if(checkboxIsChecked($("#coniferCheckbox" + plantSpeciesInput.id))){
						uncheckCheckbox($("#coniferCheckbox" + plantSpeciesInput.id));
					}
				}
			}
                        siteID = encodeURIComponent(window.location.toString().substring(window.location.toString().indexOf("?s=") + 3));
                        siteLocation = {lat: 0, lng: 0};
		        function loadCircles(){
			    var xhttp = new XMLHttpRequest();
			    xhttp.onreadystatechange = function() {
			        if (this.readyState == 4 && this.status == 200) {
			            if(this.responseText.indexOf("true|") == 0){
				        var data = JSON.parse(this.responseText.replace("true|", ""));
				        var siteName = data[0];
				        var circles = data[1];
                                        var latitude = data[2];
                                        var longitude = data[3];
                                        siteLocation.lat = parseFloat(latitude);
                                        siteLocation.lng = parseFloat(longitude);
                                        
				        $(".tagline").eq(0)[0].innerHTML = "in " + siteName;
				        populateCircles(circles);
                                        //createMap();
                                        
			            }
			            else{
				        var error = this.responseText.replace("false|", "");
                                        
				        $(".tagline").eq(0)[0].innerHTML = "Could not load.";
				        $("#error")[0].onclick = function(){window.location = "../manageMySites";};
				        $("#noticeInteractionBlock")[0].onclick = function(){window.location = "../manageMySites";};
				        queueNotice("error", error);
				        if(error == "Your log in dissolved. Maybe you logged in on another device."){
				            logOut();
				        }
			            }
			        }
			    };
			    xhttp.open("GET", "../php/getPlantsBySite.php?siteID=" + siteID + "&email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + window.localStorage.getItem("salt") + "&appVersion=1.6.0", true);
			    xhttp.send();
			}

			function populateCircles(circles){
				//[[circle(int), [[orientation, code, plantSpecies]]]]
				//sort circles
				circles = circles.sort(function(a,b){return a[0] - b[0];});

				var htmlToAdd = "";
				for(var i = 0; i < circles.length; i++){
					htmlToAdd += getCircleHTML(circles[i]);
				}
				$("#circles")[0].innerHTML = htmlToAdd;
				
				var plantSpeciesInputs = $(".plantSpeciesInput");
				for(var i = 0; i < plantSpeciesInputs.length; i++){
					setConifer(plantSpeciesInputs[i]);
				}
				
				$("#addNewCircle")[0].style.display = "block";
				if(circles.length > 0){
					$("#saveAllButton")[0].style.display = "block";
					attachAutoCompleteToInput($("input[type=text]"), plantSpeciesList, true);
				}
			}

			function getCircleHTML(circle){
                            
			    if(circle.length != 2){return "";}
			    for(var i = 0; i < circle[1].length; i++){
					if(circle[1][i].length < 4){return "";}
				}

				//sort plants
				var plants = circle[1].sort(function(a,b){
					if(a[0] < b[0]){return -1;}
					if(a[0] > b[0]){return 1;}
					return 0;
				});
				var noticeImage = "<img src=\"../images/notice.png\" class=\"noticeImage\" style=\"display:none;\"/>";
				for(var j = 0; j < plants.length; j++){
					if(plants[j][2].trim().toUpperCase() == "N/A"){
						noticeImage = "<img src=\"../images/notice.png\" class=\"noticeImage\"/>";
						break;
					}
				}

				var htmlToAdd = "<div class=\"circle\">";
				htmlToAdd += 	"<div class=\"circleTitle\" onclick=\"togglePlants(this.parentNode);\">Circle " + circle[0] + noticeImage + "</div>";
				htmlToAdd += 	"<div class=\"plants\">";
				for(var j = 0; j < plants.length; j++){
                                        var code = plants[j][1];
                                        var species = plants[j][2];
                                        var lat = plants[j][4];
                                        if (!lat || lat == 1 || lat == -1) lat = '';
                                        var lng = plants[j][5];
                                        if (!lng || lng == 1 || lng == -1) lng = '';
                                        var color = plants[j][6];
				        var noticeBorder = "";
				        if(plants[j][2].trim().toUpperCase() == "N/A"){
						noticeBorder = " style=\"border-right:5px solid #FF645A;\"";
					}
					
					htmlToAdd += "<div class=\"plant\" id=\"plant"+code+"\">";
					htmlToAdd += 	"<div class=\"code\" style=\"color:"+color+"\"><img src='../images/tag" + (j + 1) + ".png'/>" + code + "</div>";
					htmlToAdd += 	"<div class=\"editableFields\">";
                                        htmlToAdd +=       "<div class=\"plantTabs code"+ code +"\"><span class=\"plantTab selected\" onclick=\"showSpecies('" + code + "')\">Species</span>";
                                        htmlToAdd +=         "<span class=\"plantTab\" onclick=\"showLocation('" + code + "')\" data-code=\""+code+"\">Location</span></div>";
					htmlToAdd += 		"<div  class=\"fieldSpecies\" id=\"fieldsSpecies" + code + "\"><div class=\"editableFieldTitle\">Plant Species:</div>";
					htmlToAdd += 		"<input type=\"text\" id=\"" + code + "\" class=\"plantSpeciesInput\" value=\"" + species + "\"" + noticeBorder + " onfocus=\"this.setSelectionRange(0, 9999);setNoticeExemptingInput(this.parentNode.parentNode.parentNode.parentNode.parentNode, this);\" onblur=\"if(this.value.trim().toUpperCase() == 'N/A' || this.value.replace(/ /g, '') == ''){this.value = 'N/A';setNoticeImage(this.parentNode.parentNode.parentNode.parentNode);}else if(inArrayIgnoreCaseAndWhitespace(this.value, plantSpeciesList)){setNoticeImage(this.parentNode.parentNode.parentNode.parentNode.parentNode);}else{promptConfirm('&quot;' + this.value + '&quot; is not in our records. Have you searched for other labels? Are you sure this is the correct name and spelling of your tree species?', 'Try again.', 'Continue. I am sure!', function(){document.getElementById('" + code + "').focus();}, function(){setNoticeImage(document.getElementById('" + code + "').parentNode.parentNode.parentNode.parentNode.parentNode);});}\" oninput=\"setConifer(this);\"/>";
					htmlToAdd +=		"<div class=\"checkboxTableHolder\">";
					htmlToAdd +=			"<table class=\"checkboxTable\" id=\"checkboxTable" + code + "\">";
					htmlToAdd +=				"<tr onclick=\"toggleCheckbox($(this).find('.checkbox'));lastManualConiferSettings['" + code + "'] = $(this).has('.checked').length > 0;\">";
					htmlToAdd +=					"<td><div class=\"checkbox" + (plants[j][3] ? " checked" : "") + "\" id=\"coniferCheckbox" + code + "\"></div></td>";
					htmlToAdd +=					"<td>This plant is coniferous.</td>";
					htmlToAdd +=					"<td onclick=\"event.stopPropagation();queueNotice('alert', 'Coniferous plants bear cones and have needle-like or scale-like leaves that are typically evergreen.<br/><br/><img src=\\'../images/conifer.jpeg\\'/>');\"><img src=\"../images/question.png\"/></td>";
					htmlToAdd +=				"<tr>";
					htmlToAdd +=			"</table>";
					htmlToAdd +=			"<div id=\"checkboxTableOverlay" + code + "\" class=\"checkboxTableOverlay\" onclick=\"queueNotice('alert', 'We\\'ve recognized this plant species and set its &quot;conifer&quot; checkbox automatically, so it is not editable.');\"></div>";
					htmlToAdd +=		"</div></div>";
                                        htmlToAdd +=            "<div class=\"fieldsLocation\" id=\"fieldsLocation" + code + "\"><div class=\"editableFieldTitle\"></div>";
                                        htmlToAdd +=            "<div class=\"moveMapLabel\">Move the pin marker to specify the location of branch "+ code +".</div>";
                                        htmlToAdd +=            "<div id=\"map"+code+"\" class=\"plantMap\" data-code=\""+code+"\" data-lat=\""+lat+"\" data-lng=\""+lng+"\" data-orig-lat=\""+lat+"\" data-orig-lng=\""+lng+"\" data-species=\""+species+"\"></div>";
                                        htmlToAdd +=            "<div class=\"moveMapQuestion\">Are you moving this code's tag at your site? If so, confirm the species and check the box below.</div>";
                                        htmlToAdd +=            "</div>";
				        htmlToAdd +=		"<table class=\"checkboxTable locationChange "+ ((species == 'N/A' && !lat) ? "hideForNew" : "")+"\">";
					htmlToAdd +=			"<tr onclick=\"toggleCheckbox($(this).find('.checkbox'));\">";
					htmlToAdd +=				"<td><div class=\"checkbox\" id=\"moveCheckbox" + code + "\"></div></td>";
				        htmlToAdd +=				"<td>I am moving this survey branch to a new location or a different plant species.</td>";
					htmlToAdd +=				"<td onclick=\"event.stopPropagation();queueNotice('alert', 'If a tag with the code &quot;" + code + "&quot; is hanging on a tree that is dead or otherwise no longer suitable to collect surveys with, check this checkbox and move that tag to another nearby tree. If the new tree is of a different species than the unsuitable tree, go ahead and change the plant species as well. Make sure to click the &quot;Save All&quot; button at the bottom of the page before exiting the page.');\"><img src=\"../images/question.png\"/></td>";
				        htmlToAdd +=			"<tr>";
				        htmlToAdd +=		"</table>";
				        htmlToAdd += 	"</div>";
				        htmlToAdd += "</div>";
					
					lastManualConiferSettings[code] = plants[j][3];
				}
				htmlToAdd += 	"</div>";
 				htmlToAdd += "</div>";
				return htmlToAdd;
			}

			function togglePlants(circle){
				var plants = $(circle).find(".plants").eq(0)[0];

				//reset all
				$(".circle").css({border:"2px solid #eee"});
				$(".plants").stop().animate({maxHeight:"0px"});
				$(".circleTitle").stop().animate({backgroundColor:"#f7f7f7", color:"#aaa"});

				if(plants.style.maxHeight == "" || plants.style.maxHeight == "0px"){
					$(circle).css({border:"0px none transparent"});
				        $(plants).stop().animate({maxHeight:"3200px"});
					$(circle).find(".circleTitle").eq(0).stop().animate({backgroundColor:"#444", color:"#fff"});
				}
				else{
					$(plants).stop().animate({maxHeight:"0px"});
				}
			}

                        function showSpecies(code) {
                          $(".plantTabs.code"+code+" .plantTab.selected").removeClass("selected");
                          $(".plantTabs.code"+code+" .plantTab:nth-of-type(1)").addClass("selected");
                          
                          $("#fieldsSpecies"+code).css({display: "block"});
                          $("#fieldsLocation"+code).css({display: "none"});
                            
                        }
                        function showLocation(code) {
                          // switch other location tabs
                          for (let el of $(".plantTabs .plantTab:nth-of-type(2).selected")) {
                              showSpecies($(el).data('code'));
                          }
                          // 
                          $(".plantTabs.code"+code+" .plantTab.selected").removeClass("selected");
                          $(".plantTabs.code"+code+" .plantTab:nth-of-type(2)").addClass("selected");

                          $("#fieldsSpecies"+code).css({display: "none"});
                          $("#fieldsLocation"+code).css({display: "block"});
                          $("#map"+code).append(document.getElementById("map-canvas"));
                          setMarker(code);
                        }

                        map = null;
                        marker = null;
                        dblclicker = null;
                        popUp = null;
                        otherMarkers = [];
                 
                        async function createMap() {
                            const { Map, InfoWindow } = await google.maps.importLibrary("maps");
                            map = new Map(document.getElementById("map-canvas"), {
                                center: { lat: siteLocation.lat, lng: siteLocation.lng },
                                zoom: 17,
                                mapId: '165a88552a1b4169',
                                mapTypeId: 'satellite',
                                mapTypeControlOptions: {
                                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                                    mapTypeIds: ["satellite", "roadmap", "terrain"],
                                },
                                streetViewControl: false,
                                fullscreenControl: false,
                                disableDoubleClickZoom: true
                            });
                            await import("../js/maps.js?v=3");
                            MapFullscreenButton(map);
                            MapFindSiteButton(map);
                            MapFindMeButton(map);
                            
                        }

                        async function setMarker(code) {
                            const { PinElement, AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                            

                            let loc = new google.maps.LatLng(siteLocation.lat, siteLocation.lng);
                            if ($("#map"+code).data("lat")) {
                                loc = new google.maps.LatLng($("#map"+code).data("lat"), $("#map"+code).data("lng"));
                            }
                            map.panTo(loc)

                            let hasSpecies = $("#map"+code).data("species") != "N/A";
                            let hasLocation = $("#map"+code).data("orig-lat");

                            function getLabelNode(co) {
                                return $("#map"+co).closest(".plant").find(".code")[0].cloneNode(true);
                                
                            }
                            var node = getLabelNode(code);

                            // clear other markers
                            for (let m of otherMarkers) {
                                m.setMap(null);
                            }

                            otherMarkers = [];
                     
                            $("#map"+code).closest(".circle").find(".plantMap").each(function(n) {
                                var m = $(this);
                                if (m.data("code") == code) { return }
                                var no = getLabelNode(m.data("code"));
                                var label = new MapPopUp(new google.maps.LatLng(m.data("lat"), m.data("lng")), no, false, 0)
                                label.setMap(map);
                                otherMarkers.push(label);
                            });

                            const pin = new PinElement({
                                background: "#f7f7f7",
                                borderColor: "#aaa",
                                glyphColor: "#aaa"
                            });

                            if(marker) {
                                marker.map = null;
                            }

                            marker = new AdvancedMarkerElement({
                                map,
                                position: loc,
                                title: code,
                                content: pin.element,
                                gmpDraggable: true
                            });


                            if (popUp) { popUp.setMap(null)};
                            popUp = new MapPopUp(marker.position, node, false, 40);
                            popUp.setMap(map);

                            const showCode = (event) => {
                                popUp.setMap(null);
                                popUp.position = marker.position;
                                popUp.setMap(map);
                            }
                            showCode();

                            marker.addListener("drag", (event) => {
                                showCode();
                            });
                            let moved = (event) => {
                                if (hasSpecies && hasLocation) {
                                    $('#plant'+code+" .moveMapQuestion").show();
                                }
                                $("#map"+code).data("lat", marker.position.lat);
                                $("#map"+code).data("lng", marker.position.lng);
                                showCode();
                                map.panTo(marker.position);
                            }
                            marker.addListener("dragend", moved);

                            if (dblclicker && dblclicker.remove) {
                                dblclicker.remove()
                            }
                            
                            dblclicker = map.addListener("dblclick", (ev) => {
                                marker.position = ev.latLng;
                                moved()
                            });
                            
                        }
                 
		 function setNoticeImage(circle){
				var inputs = $(circle).find("input");

				var showNotice = false;
				for(var i = 0; i < inputs.length; i++){
					if(inputs.eq(i)[0].value.trim().toUpperCase() == "N/A"){
						showNotice = true;
						inputs.eq(i)[0].style.borderRight = "5px solid #FF645A";
					}
					else{
						inputs.eq(i)[0].style.borderRight = "";
					}
				}

				if(showNotice){
					$(circle).find(".noticeImage").eq(0)[0].style.display = "block";
				}
				else{
					$(circle).find(".noticeImage").eq(0)[0].style.display = "none";
				}
			}

			function setNoticeExemptingInput(circle, exemptInput){
				var inputs = $(circle).find("input");

				var showNotice = false;
				for(var i = 0; i < inputs.length; i++){
					if(inputs.eq(i)[0] != $(exemptInput)[0] && inputs.eq(i)[0].value.trim().toUpperCase() == "N/A"){
						showNotice = true;
						inputs.eq(i)[0].style.borderRight = "5px solid #FF645A";
					}
					else{
						inputs.eq(i)[0].style.borderRight = "";
					}
				}

				if(showNotice){
					$(circle).find(".noticeImage").eq(0)[0].style.display = "block";
				}
				else{
					$(circle).find(".noticeImage").eq(0)[0].style.display = "none";
				}
			}

			var saving = false;
			function saveAll(){
				if(saving){return false;}

				saving = true;
				setLoadingButton($("#saveAllButton")[0], "Save all", true);

				var plantData = [];
				var inputs = $("input");
				for(var i = 0; i < inputs.length; i++){
                                    var code = inputs.eq(i)[0].id;
				    plantData[plantData.length] = [
                                        code,
                                        encodeURIComponent(inputs.eq(i)[0].value.replace(/\s\s+/g, ' ')),
                                        checkboxIsChecked($("#moveCheckbox" + code)),
                                        checkboxIsChecked($("#coniferCheckbox" + code)),
                                        $('#map'+code).data('lat'),
                                        $('#map'+code).data('lng')
                                    ];
				}
				var formData = new FormData();
				formData.append("plantData", JSON.stringify(plantData));
				formData.append("email", window.localStorage.getItem("email"));
				formData.append("salt", window.localStorage.getItem("salt"));
				$.ajax({
					url : "/php/saveAllPlantSpecies.php",
					type : 'POST',
					data : formData,
					processData: false,  // tell jQuery not to process the data
					contentType: false,  // tell jQuery not to set contentType
					success : function(data) {
						if(data.indexOf("true|") == "0"){
							queueNotice("confirmation", "Saved!");
							$("#confirmation")[0].onclick = function(){window.location = "../manageMySites";};
							$("#noticeInteractionBlock")[0].onclick = function(){window.location = "../manageMySites";};
						}
						else{
							var savingError = data.replace("false|", "");
							queueNotice("error", savingError);
							if(savingError == "Your log in dissolved. Maybe you logged in on another device."){
								logOut();
							}
						}
					},
					error : function(request, status, error){
						queueNotice("error", request.responseText);
					},
					complete: function() {
						saving = false;
						setLoadingButton($("#saveAllButton")[0], "Save all", false);
						$('html, body').animate({ scrollTop: document.getElementById("splashImage").clientHeight }, 'slow');
					}
				});
			}

			var adding = false;
			function addNewCircle(){
				if(adding){return false;}

				adding = true;
				$("#addNewCircle")[0].innerHTML = "Adding New Circle...";
				//setLoadingButton($("#saveAllButton")[0], "Save all", true);


				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						adding = false;
						$("#addNewCircle")[0].innerHTML = "Add New Circle<div class=\"plusImage\" style=\"background-image:url('../images/plus.png');\"></div>";
				    //setLoadingButton($("#saveAllButton")[0], "Save all", false);
						if(this.responseText.indexOf("true|") == "0"){
							var newPlants = JSON.parse(this.responseText.replace("true|", ""));
							$("#circles").append(getCircleHTML([($(".circle").length + 1), newPlants]));
							attachAutoCompleteToInput($(".circle").eq($(".circle").length - 1).find("input"), plantSpeciesList, true);
						}
						else{
							$('html, body').animate({ scrollTop: document.getElementById("splashImage").clientHeight }, 'slow');
				                        var addingError = this.responseText.replace("false|", "");
							queueNotice("error", addingError);
							if(addingError == "Your log in dissolved. Maybe you logged in on another device."){
								logOut();
							}
						}
					}
				};
				xhttp.open("GET", "../php/addCircle.php?siteID=" + encodeURIComponent(siteID) + "&email=" + encodeURIComponent(window.localStorage.getItem("email")) + "&salt=" + window.localStorage.getItem("salt") + "&appVersion=1.5.0", true);
				xhttp.send();
			}
		</script>
	</head>
	<body>
		<div id="managerRequest">
			<div id="managerRequestMessage"></div>
			<div id="managerRequestButtons">
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('deny');">Deny</div>
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('approve');">Accept</div>
			</div>
		</div>
		<div id="error" onclick="hideNotice();"></div>
		<div id="confirmation" onclick="hideNotice();"></div>
		<div id="alert" onclick="hideNotice();"></div>
		<div id="promptInteractionBlock"></div>
		<div id="noticeInteractionBlock" onclick="hideNotice();"></div>
		<div id="confirm">
			<div></div>
			<div>
				<button>OK</button>
				<button>Cancel</button>
				<div class="clearBoth"></div>
			</div>
		</div>

		<div id="splash" class="mobileOptional">
			<div id="splashImage"></div>
			<div id="splashOverlay">
				<div id="splashIntroText">Welcome to</div>
				<div id="splashMainText">Caterpillars Count!</div>
				<button id="splashButton" onclick="this.blur();scrollToPanel(1);">Edit Survey Plants</button>
			</div>
		</div>
		<header>
			<h1><a href="../">Caterpillars Count!</a></h1>
			<div id="hamburger" onclick="toggleNav();">
				<div></div>
				<div></div>
				<div></div>
			</div>
			<div id="navKnockDown" class="clearBoth"></div>
			<nav class="loadingNav">
				<ul>
					<li onclick="accessSubMenu(this);">
						<span>Participate</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../getStarted">Get Started</a></li>
							<li><a href="../conductASurvey">Conduct a Survey</a></li>
							<li><a href="../submitObservations">Submit Observations</a></li>
							<li><a href="../hostASurveySite">Host a Survey Site</a></li>
							<li><a href="../resources">Resources</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Explore</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../mapsAndGraphs">Maps & Graphs</a></li>
							<li><a href="https://www.inaturalist.org/observations?project_id=5443&verifiable=any">Recent Observations</a></li>
							<li><a href="../reports">Reports</a></li>
							<li><a href="../publications">Publications</a></li>
							<li><a href="../dataDownload">Data Download</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Learn</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../identificationSkills">Identification Skills</a></li>
							<li><a href="../surveyProtocolQuiz">Survey Protocol Quiz</a></li>
							<li><a href="../virtualSurvey">Virtual Survey Game</a></li>
							<li><a href="../forEducators">For Educators</a></li>
						</ul>
					</li>
					<li onclick="window.location = '../news';">
						<span>News</span>
					</li>
					<li onclick="window.location = '../faq';">
						<span>FAQ</span>
					</li>
					<li onclick="window.location = '../signIn';">
						<span>Sign In</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../createNewSite">Create New Site</a></li>
							<li><a href="../manageMySites">Manage My Sites</a></li>
							<li><a href="../manageMySurveys">Manage My Surveys</a></li>
							<li><a href="../userDashboard">My Stats</a></li>
							<li><a href="../settings">Settings</a></li>
							<li><a href="" onclick="logOut();">Sign Out</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<div id="navBack" onclick="resetMenu(false);">&#10094;</div>
		</header>
		<main>
			<div class="panel">
				<h2>Edit Survey Plants</h2>
				<div class="tagline">This site's plants are loading. Please wait a moment.</div>
				<div class="content">
					<div id="circles"></div>
                                        <div style="display:none;"><div id="map-canvas"></div></div>
					<div id="addNewCircle" onclick="promptConfirm('You cannot remove a circle once it has been created. Are you sure you want to add a new circle?', 'Never mind.', 'Yes, I am sure!', function(){}, addNewCircle);">
						Add New Circle
						<div class="plusImage" style="background-image:url('../images/plus.png');"></div>
					</div>
					<button id="saveAllButton" onclick="saveAll();">Save all</button>
					<div style="text-align:center;margin-bottom:20px;" class="underline"><a href="../manageMySites" style="color:#ccc;font-size:16px;font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;">Cancel</a></div>
				</div>
			</div>
		</main>
		<footer>
			<div>Part of the <a href="http://pheno-mismatch.org" target="_blank">Pheno Mismatch</a> project funded by the National Science Foundation</div>

			<div><img src="../images/unc.png"/></div><div>
				<a target="_blank" href="https://www.facebook.com/Caterpillars-Count-1854259101283140/"><img src="../images/facebook.png" alt="facebook"/></a><a target="_blank" href="https://twitter.com/CaterpillarsCt"><img src="../images/twitter.png" alt="twitter"/></a>
			</div>

			<div>Contact us: <a href="mailto:caterpillarscount@gmail.com">caterpillarscount@gmail.com</a></div>

			<div>View our <a href="../privacyPolicy">privacy policy</a></div>
		</footer>
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1mAwi8Cs7H5vCpTApTkdHLgU_9Mimlko&loading=async&callback=createMap"></script>
	</body>
</html>
