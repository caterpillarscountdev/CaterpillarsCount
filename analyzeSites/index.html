<html>
	<head>
		<!-- Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113319025-1"></script>
		<script>
  			window.dataLayer = window.dataLayer || [];
  			function gtag(){dataLayer.push(arguments);}
  			gtag('js', new Date());
			gtag('config', 'UA-113319025-1');
		</script>
		<!-- End of Google Analytics -->

		<title>Analyze Sites | Caterpillars Count!</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Fanwood+Text:400i" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
		<link href="../css/template.css" rel="stylesheet">
		<script src="../js/template.js?v=1"></script>
		<style>
			#sitesLoading{
				background:#e6e6e6;
				text-align:center;
				padding:16px;
				border-radius:4px;
    				overflow:hidden;
			}
			#sitesLoading img{
				height:22px;
			}
			
			.select{
				width:100%;
				-webkit-appearance: none;
    				-moz-appearance: none;
    				appearance: none;
    				border-radius:4px;
    				overflow:hidden;
    				background:#fff;
				border:1px solid #ddd;
				border-bottom:2px solid #ddd;
				color:#aaa;
				box-sizing:border-box;
				margin-top:5px;
				cursor:pointer;
			}
			.select{
				padding:0px;
				color:#aaa;
				font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
			}
			.select .option{
				max-height:0px;
				overflow:hidden;
			}
			.select .option.selected{
				max-height:250px;
				overflow:hidden;
			}
			.select .option .value{
				display:none;
			}
			.select .option .shown{
				padding:16px;
				position:relative;
				font-size:16px;
			}
			.select .option:nth-of-type(even){
				background:#f7f7f7;
			}
			.select .option .shown .image{
				height:34px;
				width:34px;
				background-size:contain;
				background-repeat:no-repeat;
				background-position:center;
				display:inline-block;
				opacity:.4;
				position:absolute;
				right:20px;
				top:10px;
			}
			.select .option .shown .text{
				display:inline-block;
			}
			
			#analysisPanel{
				display:none;
				font-family: 'Roboto Slab', serif;
			}
			
			#analysis>div{
				margin-bottom:20px;
			}
			
			#analysis>div:last-of-type{
				margin-bottom:0px;
			}
			
			#analysis .title{
				font-weight:bold;
				text-transform:uppercase;
				padding-right:5px;
			}
			
			#analysis .title, #analysis .stat{
				display:inline-block;
			}
		</style>
		<script>
			$(document).ready(function(){
				loadBackgroundImage($("#splashImage"), "../images/splash.png");
				populateSites();
			});
      
      			function populateSites(){
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						if(this.responseText.indexOf("true") == 0){
							var ownedSites = JSON.parse(this.responseText.replace("true|", ""));
							ownedSites.sort(function(a, b){
								if((a["name"] + " (" + a["region"] + ")").toLowerCase() < (b["name"] + " (" + b["region"] + ")").toLowerCase()){return -1;}
								if((a["name"] + " (" + a["region"] + ")").toLowerCase() > (b["name"] + " (" + b["region"] + ")").toLowerCase()){return 1;}
								return 0;
							});
							var htmlToAdd = "<div class=\"select\" id=\"siteSelect\">";
							htmlToAdd += "<div class=\"option selected\" onclick=\"selectOption(this);stopAnalysis();\">	<div class=\"value\"></div>			<div class=\"shown\"><div class=\"image\" style=\"background-image:url('../images/selectIcons/notselected.png');\"></div>		<div class=\"text\">Not selected</div></div></div>";
							for(var i = 0; i < ownedSites.length; i++){
								htmlToAdd += "<div class=\"option\" onclick=\"selectOption(this);analyze();\">	<div class=\"value\">" + ownedSites[i]["id"] + "</div>			<div class=\"shown\"><div class=\"image\"></div>		<div class=\"text\">" + ownedSites[i]["name"] + " (" + ownedSites[i]["region"] + ")</div></div></div>";
								//htmlToAdd += "<option value=\"" + ownedSites[i]["id"] + "\">" + ownedSites[i]["name"] + " (" + ownedSites[i]["region"] + ")</option>";
							}
							htmlToAdd += "</div>";
							$("#sites")[0].innerHTML = htmlToAdd;
						}
						else{
							var getSitesError = this.responseText.replace("false|", "");
							queueNotice("error", getSitesError);
							if(getSitesError == "Your log in dissolved. Maybe you logged in on another device."){
								logOut();
							}
						}
					}
				};
				xhttp.open("GET", "../php/getAllSitesLIGHT.php", true);
				xhttp.send();
			}
      
      			function toggleMaxHeight(elements){
				//switch the max height of all elements specified as "elements" between 0px and 250px
				elements = $(elements);
				for(var i = 0; i < elements.length; i++){
					if(elements.eq(i)[0].style.maxHeight != "250px"){
						elements.eq(i).stop().animate({maxHeight:"250px"});
					}
					else{
						elements.eq(i).stop().animate({maxHeight:"0px"});
					}
				}
			}
			var selectToggling = false;
			function autoOpenSelect(selectElement){
				if(!selectToggling){
					selectToggling = true;
					if(getSelectValue(selectElement) == ""){
						if($(selectElement)[0].className.indexOf("active") > -1){
							var activeClassName = $(selectElement)[0].className.substring($(selectElement)[0].className.indexOf("active"));
							if(activeClassName.indexOf(" ") > -1){
								activeClassName = activeClassName.substring(0, activeClassName.indexOf(" "));
							}
							$(selectElement)[0].className = $(selectElement)[0].className.replace(activeClassName, "").trim();
						}
						$(selectElement)[0].className = $(selectElement)[0].className + " active" + (getYPosition(selectElement) - 100);
						elements = $(selectElement).find(".option").animate({maxHeight:"250px"}, "swing", function(){selectToggling = false;});
					}
				}
			}
			function selectOption(optionElement){
				if(!selectToggling){
					selectToggling = true;
					//select an option in a custiom .select or open the custom .select
					if(optionElement.parentNode.className.indexOf("active") > -1){
						var preScrollTop = Number(optionElement.parentNode.className.replace(/\D/g, ""));
						optionElement.parentNode.className = optionElement.parentNode.className.replace("active" + preScrollTop, "").trim();
						$('html, body').animate({ scrollTop: preScrollTop }, 400);
					}
					else{
						optionElement.parentNode.className = optionElement.parentNode.className + " active" + $(document).scrollTop();
					}
					toggleMaxHeight($(optionElement.parentNode).find(".option"));
					var selectedElement = $(optionElement.parentNode).find(".selected").eq(0)[0];
					selectedElement.className = selectedElement.className.replace("selected", "").trim();
					optionElement.className = optionElement.className + " selected";
					$(optionElement).stop().animate({maxHeight:"250px"}, "swing", function(){selectToggling = false});
				}
			}
			function setSelectValue(selectElement, val){
				//set the value of a custom .select and show the selected option
				selectElement = $(selectElement)[0];
				var options = selectElement.getElementsByClassName("option");
				for(var i = 0; i < options.length; i++){
					options[i].className = "option";
					options[i].style.maxHeight = "0px";
					options[i].style.overflow = "hidden";
					if(options[i].getElementsByClassName("value")[0].innerHTML == val){
						options[i].className = "option selected";
						options[i].style.maxHeight = "250px";
						options[i].style.overflow = "hidden";
					}
				}
			}
			function getSelectValue(selectElement){
				//return the value of a custom .select
				if($(selectElement).find(".selected .value").length < 1){
					return "";
				}
				return $(selectElement).find(".selected .value")[0].innerHTML;
			}
			function getSelectText(selectElement){
				//return the show text of a custom .select
				return $(selectElement).find(".selected .text")[0].innerHTML;
			}
			function getSelectTextByValue(selectElement, val){
				//given the value of a custom .select, return that values corresponding text
				selectElement = $(selectElement)[0];
				var options = selectElement.getElementsByClassName("option");
				for(var i = 0; i < options.length; i++){
					if($(options[i]).find(".value").eq(0)[0].innerHTML == val){
						return $(options[i]).find(".text").eq(0)[0].innerHTML;
					}
				}
			}
			function getSelectValueByText(selectElement, txt){
				//given the value of a custom .select, return that values corresponding text
				selectElement = $(selectElement)[0];
				var options = selectElement.getElementsByClassName("option");
				for(var i = 0; i < options.length; i++){
					if($(options[i]).find(".text").eq(0)[0].innerHTML == txt){
						return $(options[i]).find(".value").eq(0)[0].innerHTML;
					}
				}
			}
			function getSelectImageByText(selectElement, txt){
				//given the value of a custom .select, return that values corresponding text
				selectElement = $(selectElement)[0];
				var options = selectElement.getElementsByClassName("option");
				for(var i = 0; i < options.length; i++){
					if($(options[i]).find(".text").eq(0)[0].innerHTML == txt){
						bgimg = $(options[i]).find(".image").eq(0)[0].style.backgroundImage;
						return bgimg.substring(bgimg.indexOf("(") + 1, bgimg.lastIndexOf(")")).replace(/"/g, "").replace(/'/g, "");
						//TODO: remove this line. "
					}
				}
			}
			
			var lastSiteID = "";
			var callNumber = 0;
			function analyze(){
				var siteID = getSelectValue($("#siteSelect"));
				if(siteID != lastSiteID){
					lastSiteID = siteID;
					var thisCallNumber = ++callNumber;
					$.get("../php/getSiteAnalysis.php?siteID=" + siteID, function(data){
						//success
						if(data.indexOf("true|") == 0){
							if(thisCallNumber == callNumber){
								var siteAnalysis = JSON.parse(data.replace("true|", ""));
								
								var htmlToAdd = "<div>";
								htmlToAdd += 	"<div class=\"title\">Site name:</div>";
								htmlToAdd += 	"<div class=\"stat\">" + siteAnalysis["name"] + "</div>";
								htmlToAdd += "</div>";
								
								htmlToAdd += "<div>";
								htmlToAdd += 	"<div class=\"title\">Site authority emails:</div>";
								htmlToAdd += 	"<div class=\"stat\">" + siteAnalysis["emails"].join(", ") + "</div>";
								htmlToAdd += "</div>";
								
								htmlToAdd += "<div>";
								htmlToAdd += 	"<div class=\"title\">Number of plants:</div>";
								htmlToAdd += 	"<div class=\"stat\">" + siteAnalysis["plantCount"] + "</div>";
								htmlToAdd += "</div>";
								
								htmlToAdd += "<div>";
								htmlToAdd += 	"<div class=\"title\">Number of observers:</div>";
								htmlToAdd += 	"<div class=\"stat\">" + siteAnalysis["observerCount"] + "</div>";
								htmlToAdd += "</div>";
								
								htmlToAdd += "<div>";
								htmlToAdd += 	"<div class=\"title\">Year of first survey:</div>";
								htmlToAdd += 	"<div class=\"stat\">" + siteAnalysis["firstSurveyYear"] + "</div>";
								htmlToAdd += "</div>";
								
								htmlToAdd += "<div>";
								htmlToAdd += 	"<div class=\"title\">Most recent survey:</div>";
								htmlToAdd += 	"<div class=\"stat\">" + siteAnalysis["mostRecentSurveyDate"] + "</div>";
								htmlToAdd += "</div>";
								
								htmlToAdd += "<div>";
								htmlToAdd += 	"<div class=\"title\">Surveys in " + siteAnalysis["mostRecentSurveyDate"].split("-")[0] + ":</div>";
								htmlToAdd += 	"<div class=\"stat\">" + siteAnalysis["surveysEachWeek"] + "</div>";
								htmlToAdd += "</div>";
								
								$("#analysis")[0].innerHTML = htmlToAdd;
								$("#analysisPanel")[0].style.display = "block";
							}
						}
						else{
							queueNotice("error", data.replace("false|", ""));
						}
					})
					.fail(function(){
						//error
						queueNotice("error", "Your request did not process. You may have a weak internet connection, or our servers might be busy. Please try again.");
					});
				}
			}
			
			function stopAnalysis(){
				callNumber++;
				$("#analysis")[0].innerHTML = "";
				$("#analysisPanel")[0].style.display = "";
			}
		</script>
	</head>
	<body>
		<div id="managerRequest">
			<div id="managerRequestMessage"></div>
			<div id="managerRequestButtons">
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('deny');">Deny</div>
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('approve');">Accept</div>
			</div>
		</div>
		<div id="error" onclick="hideNotice();"></div>
		<div id="confirmation" onclick="hideNotice();"></div>
		<div id="alert" onclick="hideNotice();"></div>
		<div id="promptInteractionBlock"></div>
		<div id="noticeInteractionBlock" onclick="hideNotice();"></div>
		<div id="confirm">
			<div></div>
			<div>
				<button>OK</button>
				<button>Cancel</button>
				<div class="clearBoth"></div>
			</div>
		</div>

		<div id="splash">
			<div id="splashImage"></div>
			<div id="splashOverlay">
				<div id="splashIntroText">Welcome to</div>
				<div id="splashMainText">Caterpillars Count!</div>
				<button id="splashButton" onclick="this.blur();scrollToPanel(1);">Analyze Sites</button>
			</div>
		</div>
		<header>
			<h1><a href="../">Caterpillars Count!</a></h1>
			<div id="hamburger" onclick="toggleNav();">
				<div></div>
				<div></div>
				<div></div>
			</div>
			<div id="navKnockDown" class="clearBoth"></div>
			<nav class="loadingNav">
				<ul>
					<li onclick="accessSubMenu(this);">
						<span>Participate</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../getStarted">Get Started</a></li>
							<li><a href="../conductASurvey">Conduct a Survey</a></li>
							<li><a href="../submitObservations">Submit Observations</a></li>
							<li><a href="../hostASurveySite">Host a Survey Site</a></li>
							<li><a href="../resources">Resources</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Explore</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../mapsAndGraphs">Maps & Graphs</a></li>
							<li><a href="https://www.inaturalist.org/observations?place_id=any&subview=grid&user_id=caterpillarscount&verifiable=any">Recent Observations</a></li>
							<li><a href="../dataDownload">Data Download</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Learn</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../identificationSkills">Identification Skills</a></li>
							<li><a href="../forEducators">For Educators</a></li>
							<li><a href="../faq">FAQ</a></li>
						</ul>
					</li>
					<li onclick="window.location = '../news';">
						<span>News</span>
					</li>
					<li onclick="window.location = '../signIn';">
						<span>Sign In</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../createNewSite">Create New Site</a></li>
							<li><a href="../manageMySites">Manage My Sites</a></li>
							<li><a href="../manageMySurveys">Manage My Surveys</a></li>
							<li><a href="../settings">Settings</a></li>
							<li><a href="" onclick="logOut();">Sign Out</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<div id="navBack" onclick="resetMenu(false);">&#10094;</div>
		</header>
		<main>
			<div class="panel">
				<h2>Analyze Sites</h2>
				<div class="tagline">Select a site for analysis.</div>
				<div class="content">
					<div id="sites">
						<div id="sitesLoading">
							<img src="../images/rolling.svg"/>
						</div>
					</div>
				</div>
			</div>
			<div class="panel" id="analysisPanel">
				<div class="content">
					<div id="analysis"></div>
				</div>
			</div>
		</main>
		<footer>
			<div>Part of the <a href="http://pheno-mismatch.org" target="_blank">Pheno Mismatch</a> project funded by the National Science Foundation</div>

			<div><img src="../images/unc.png"/></div><div>
				<a target="_blank" href="https://www.facebook.com/Caterpillars-Count-1854259101283140/"><img src="../images/facebook.png" alt="facebook"/></a><a target="_blank" href="https://twitter.com/CaterpillarsCt"><img src="../images/twitter.png" alt="twitter"/></a>
			</div>

			<div>Contact us: <a href="mailto:caterpillarscount@gmail.com">caterpillarscount@gmail.com</a></div>

			<div>View our <a href="../privacyPolicy">privacy policy</a></div>
		</footer>
	</body>
</html>
