<html>
	<head>
		<!-- Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113319025-1"></script>
		<script>
  			window.dataLayer = window.dataLayer || [];
  			function gtag(){dataLayer.push(arguments);}
  			gtag('js', new Date());
			gtag('config', 'UA-113319025-1');
		</script>
		<!-- End of Google Analytics -->

		<title>Analyze Sites | Caterpillars Count!</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Fanwood+Text:400i" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
		<link href="../css/template.css" rel="stylesheet">
		<script src="../js/template.js?v=1"></script>
		<style>
			#sitesLoading{
				background:#e6e6e6;
				text-align:center;
				padding:16px;
				border-radius:4px;
    				overflow:hidden;
			}
			#sitesLoading img{
				height:22px;
			}
			.promptInput{
				margin-top:10px;
				font-size:14px;
				color:#555;
				border:0px none transparent;
				padding:10px 0px 0px 0px;
				width:100%;
				outline:none;
			}
			
			.smallSelect{
    				position:relative;
        			display:inline-block;
				text-decoration:inherit;
    			}
   			.smallSelect .selected{
				border-radius:4px;
				text-decoration:inherit;
				background:rgba(0,0,0,0.1);
				cursor:pointer;
    			}
    			.smallSelect .options{
    				position:absolute;
        			top:0px;
				left:-5px;
        			background:white;
        			min-width:100%;
        			border-radius:5px;
        			overflow:hidden;
        			border:1px solid #ddd;
        			border-bottom:2px solid #ddd;
        			font-size:12px;
        			display:none;
				z-index:2;
    			}
    			.smallSelect .options>div{
    				padding:5px;
        			cursor:pointer;
    			}
    			.smallSelect .options>div:hover{
    				background:#ebfeff;
    			}
		</style>
		<script>
			$(document).ready(function(){
				loadBackgroundImage($("#splashImage"), "../images/splash.png");
				loadTable();
			});
			
			var firstYear = 0;
			var lastYear = 0;
			var siteData = [];
			var loadChunk = 0;
			function loadTable(){
				$.get("../php/getSiteAnalysis.php?start=" + (50 * loadChunk++), function(data){
					//success
					if(data.indexOf("true|") == 0){
						var data = JSON.parse(data.replace("true|", ""));
						firstYear = data[0];
						lastYear = data[1];
						for (var siteID in data[2]){
							if(data[2].hasOwnProperty(siteID)){
								siteData[siteData.length] = {
									"siteID": siteID,
									"name": data[2][siteID]["name"],
									"url": data[2][siteID]["url"],
									"authorities": data[2][siteID]["authorities"],
									"surveysEachWeek": data[2][siteID]["surveysEachWeek"],
									"firstSurveyYear": data[2][siteID]["firstSurveyYear"],
									"plantCount": data[2][siteID]["plantCount"],
									"observerCount": data[2][siteID]["observerCount"],
									"mostRecentSurveyDate": data[2][siteID]["mostRecentSurveyDate"]
								};
							}
						}
						if(data[3]){
							showTable(0);
						}
						else{
							loadTable();
						}
					}
					else{
						queueNotice("error", data.replace("false|", ""));
					}
				})
				.fail(function(){
					//error
					queueNotice("error", "Your request did not process. You may have a weak internet connection, or our servers might be busy. Please reload the page to try again.");
				});
			}
			
			function showTable(sortingIndex){
				var htmlToAdd = "";
				
				for(var i = 0; i < siteData.length; i++){
					var authorityNames = [];
					for(var j = 0; j < siteData[i]["authorities"].length; j++){
						authorityNames[authorityNames.length] = siteData[i]["authorities"][j][0];
					}
					
					htmlToAdd += "<div class=\"table\">";
					if(siteData[i]["url"] == ""){
						htmlToAdd += 	"<div class=\"cell\">" + siteData[i]["name"] + "</div>";
					}
					else{
						htmlToAdd += 	"<div class=\"cell\"><a href=\"" + siteData[i]["url"] + "\" target=\"_blank\" class=\"highlighted\">" + siteData[i]["name"] + "</a></div>";
					}
					htmlToAdd += 	"<div class=\"cell\"><span class=\"highlighted pointer\" onclick=\"\"emailAuthorities('" + siteData[i]["siteID"] + "');>" + authorityNames + "</span></div>";
					htmlToAdd += 	"<div class=\"cell\">" + siteData[i]["firstSurveyYear"] + "</div>";
					htmlToAdd += 	"<div class=\"cell\">" + siteData[i]["plantCount"] + "</div>";
					htmlToAdd += 	"<div class=\"cell\">" + siteData[i]["observerCount"] + "</div>";
					htmlToAdd += 	"<div class=\"cell\">" + siteData[i]["mostRecentSurveyDate"] + "</div>";
					htmlToAdd += 	"<div class=\"cell\">" + siteData[i]["surveysEachWeek"].join(", ") + "</div>";
					htmlToAdd += "</div>";
				}
			}
			
			function emailAuthorities(siteID){
				var fullAuthorityEmails = [];
				for(var i = 0; i < siteData.length; i++){
					if(Number(siteData[i]["siteID"]) == Number(siteID)){
						for(var j = 0; j < siteData[i]["authorities"]; j++){
							fullAuthorityEmails[j] = siteData[i]["authorities"][j][1].join("@");
						}
					}
				}
				promptConfirm("Here are the site authority email addresses:<br/><input type=\"text\" class=\"promptInput\" value=\"" + fullAuthorityEmails.join(', ') + "\" readonly onclick=\"this.outerHTML=this.outerHTML;this.blur();$('.promptInput').eq(0)[0].select();\"/>", "Never mind.", , "Copy to clipboard!", function(){}, function(){
					$('.promptInput').eq(0)[0].outerHTML = $('.promptInput').eq(0)[0].outerHTML;
					$('.promptInput').eq(0)[0].select();
					var copied = true;
					try{
						document.execCommand("copy");
					}
					catch(err){
						copied = false;
						setTimeout(function(){
							promptConfirm("<strong>Sorry! We had trouble copying that for you. Please manually right-click and copy our email address:</strong><br/><input type=\"text\" class=\"promptInput\" value=\"" + fullAuthorityEmails.join(', ') + "\" readonly onclick=\"this.outerHTML=this.outerHTML;this.blur();$('.promptInput').eq(0)[0].select();\"/>", "Never mind.", "Got it!", function(){}, function(){});
							$(".promptInput").eq(0)[0].select();
						}, 1);
					}
					if(copied){
						queueNotice("confirmation", "Copied to clipboard!");
					}
				});
				$(".promptInput").eq(0)[0].select();
			}
		</script>
	</head>
	<body>
		<div id="managerRequest">
			<div id="managerRequestMessage"></div>
			<div id="managerRequestButtons">
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('deny');">Deny</div>
				<div class="managerRequestButton" onclick="hideNotice();respondToManagerRequest('approve');">Accept</div>
			</div>
		</div>
		<div id="error" onclick="hideNotice();"></div>
		<div id="confirmation" onclick="hideNotice();"></div>
		<div id="alert" onclick="hideNotice();"></div>
		<div id="promptInteractionBlock"></div>
		<div id="noticeInteractionBlock" onclick="hideNotice();"></div>
		<div id="confirm">
			<div></div>
			<div>
				<button>OK</button>
				<button>Cancel</button>
				<div class="clearBoth"></div>
			</div>
		</div>

		<div id="splash">
			<div id="splashImage"></div>
			<div id="splashOverlay">
				<div id="splashIntroText">Welcome to</div>
				<div id="splashMainText">Caterpillars Count!</div>
				<button id="splashButton" onclick="this.blur();scrollToPanel(1);">Analyze Sites</button>
			</div>
		</div>
		<header>
			<h1><a href="../">Caterpillars Count!</a></h1>
			<div id="hamburger" onclick="toggleNav();">
				<div></div>
				<div></div>
				<div></div>
			</div>
			<div id="navKnockDown" class="clearBoth"></div>
			<nav class="loadingNav">
				<ul>
					<li onclick="accessSubMenu(this);">
						<span>Participate</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../getStarted">Get Started</a></li>
							<li><a href="../conductASurvey">Conduct a Survey</a></li>
							<li><a href="../submitObservations">Submit Observations</a></li>
							<li><a href="../hostASurveySite">Host a Survey Site</a></li>
							<li><a href="../resources">Resources</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Explore</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../mapsAndGraphs">Maps & Graphs</a></li>
							<li><a href="https://www.inaturalist.org/observations?place_id=any&subview=grid&user_id=caterpillarscount&verifiable=any">Recent Observations</a></li>
							<li><a href="../dataDownload">Data Download</a></li>
						</ul>
					</li>
					<li onclick="accessSubMenu(this);">
						<span>Learn</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../identificationSkills">Identification Skills</a></li>
							<li><a href="../forEducators">For Educators</a></li>
							<li><a href="../faq">FAQ</a></li>
						</ul>
					</li>
					<li onclick="window.location = '../news';">
						<span>News</span>
					</li>
					<li onclick="window.location = '../signIn';">
						<span>Sign In</span>
						<ul onclick="event.stopPropagation();">
							<li class="closeSubmenu" onclick="closeSubmenu(this.parentNode);"><img src="../images/arrow.png"/></li>
							<li><a href="../createNewSite">Create New Site</a></li>
							<li><a href="../manageMySites">Manage My Sites</a></li>
							<li><a href="../manageMySurveys">Manage My Surveys</a></li>
							<li><a href="../settings">Settings</a></li>
							<li><a href="" onclick="logOut();">Sign Out</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<div id="navBack" onclick="resetMenu(false);">&#10094;</div>
		</header>
		<main>
			<div class="panel">
				<h2>Analyze Sites</h2>
				<div class="content">
					<div id="analysis">
						<div id="sitesLoading">
							<img src="../images/rolling.svg"/>
						</div>
					</div>
				</div>
			</div>
		</main>
		<footer>
			<div>Part of the <a href="http://pheno-mismatch.org" target="_blank">Pheno Mismatch</a> project funded by the National Science Foundation</div>

			<div><img src="../images/unc.png"/></div><div>
				<a target="_blank" href="https://www.facebook.com/Caterpillars-Count-1854259101283140/"><img src="../images/facebook.png" alt="facebook"/></a><a target="_blank" href="https://twitter.com/CaterpillarsCt"><img src="../images/twitter.png" alt="twitter"/></a>
			</div>

			<div>Contact us: <a href="mailto:caterpillarscount@gmail.com">caterpillarscount@gmail.com</a></div>

			<div>View our <a href="../privacyPolicy">privacy policy</a></div>
		</footer>
	</body>
</html>
